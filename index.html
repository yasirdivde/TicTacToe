<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cozy Wood Tic Tac Toe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Patrick Hand', cursive;
            background-color: #fdfaed;
            background-image: url('https://www.transparenttextures.com/patterns/wood-pattern.png');
        }
        .btn-chunky {
            transition: all 0.1s ease-in-out;
            border-bottom-width: 4px;
        }
        .btn-chunky:active {
            transform: translateY(2px);
            border-bottom-width: 2px;
        }
        .config-btn.selected {
            background-color: #78350f; /* amber-900 */
            color: #fef3c7; /* amber-100 */
            border-color: #451a03; /* amber-950 */
            transform: scale(1.05);
        }
        .cell-highlight {
            box-shadow: 0 0 20px 5px rgba(255, 237, 119, 0.8);
        }
        .screen {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            width: 100%;
        }
        .screen.hidden {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
            position: absolute;
        }
        #emoji-reaction {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            font-size: 8rem;
            opacity: 0;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            z-index: 50;
            pointer-events: none;
        }
        #emoji-reaction.show {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }
        .chat-message {
            max-width: 80%;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">

    <div class="container mx-auto p-4 max-w-lg relative">

        <!-- All Screens Container -->
        <div id="screens-container" class="relative">
            <!-- Name Entry -->
            <section id="name-screen" class="screen hidden">
                <div class="bg-amber-100 p-8 rounded-2xl shadow-lg border-4 border-amber-900/20 text-center">
                    <h1 class="text-6xl font-bold text-amber-900 mb-2">Tic Tac Toe</h1>
                    <p class="text-amber-700 text-2xl mb-6">Cozy Wood Edition</p>
                    <input type="text" id="player-name-input" placeholder="Enter Your Name" class="w-full text-2xl p-3 rounded-lg border-2 border-amber-300 focus:border-amber-600 focus:ring-0 text-center text-amber-900 mb-4">
                    <button id="save-name-btn" class="w-full bg-amber-800 text-amber-100 text-3xl py-4 px-8 rounded-lg shadow-md border-amber-950 btn-chunky hover:bg-amber-700">Continue</button>
                </div>
            </section>
            
            <!-- Main Menu -->
            <section id="main-menu" class="screen hidden">
                 <div class="bg-amber-100 p-8 rounded-2xl shadow-lg border-4 border-amber-900/20 text-center">
                    <div class="flex items-center justify-center mb-6">
                        <h2 id="welcome-message" class="text-4xl font-bold text-amber-900 truncate"></h2>
                        <button id="edit-name-btn" class="ml-3 text-amber-600 hover:text-amber-800">
                            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                        </button>
                    </div>
                    <div class="space-y-4">
                        <button id="vs-computer-btn" class="w-full bg-amber-800 text-amber-100 text-3xl py-4 px-8 rounded-lg shadow-md border-amber-950 btn-chunky hover:bg-amber-700">Play vs Computer</button>
                        <button id="vs-player-btn" class="w-full bg-amber-600 text-amber-900 text-3xl py-4 px-8 rounded-lg shadow-md border-amber-800 btn-chunky hover:bg-amber-500">Pass N Play</button>
                        <button id="online-btn" class="w-full bg-sky-700 text-sky-100 text-3xl py-4 px-8 rounded-lg shadow-md border-sky-900 btn-chunky hover:bg-sky-600">Play with Friend</button>
                    </div>
                </div>
            </section>

            <!-- Computer Setup -->
            <section id="computer-setup-screen" class="screen hidden">
                <div class="bg-amber-100 p-8 rounded-2xl shadow-lg border-4 border-amber-900/20">
                     <h2 class="text-4xl font-bold text-amber-900 mb-6 text-center">Computer Setup</h2>
                    <div class="mb-6">
                        <label class="text-2xl text-amber-800 mb-2 block text-center">Difficulty:</label>
                        <div class="flex justify-center space-x-2">
                            <button data-difficulty="easy" class="difficulty-btn config-btn flex-1 text-2xl py-2 px-4 rounded-lg shadow-md border-amber-800 btn-chunky bg-amber-600 text-amber-900 selected">Easy</button>
                            <button data-difficulty="medium" class="difficulty-btn config-btn flex-1 text-2xl py-2 px-4 rounded-lg shadow-md border-amber-800 btn-chunky bg-amber-600 text-amber-900">Medium</button>
                            <button data-difficulty="hard" class="difficulty-btn config-btn flex-1 text-2xl py-2 px-4 rounded-lg shadow-md border-amber-800 btn-chunky bg-amber-600 text-amber-900">Hard</button>
                        </div>
                    </div>
                    <div class="mb-8">
                        <label class="text-2xl text-amber-800 mb-2 block text-center">Choose your mark:</label>
                        <div class="flex justify-center space-x-2">
                            <button data-mark="X" class="mark-btn config-btn flex-1 text-5xl py-2 px-4 rounded-lg shadow-md border-amber-800 btn-chunky bg-amber-600 text-red-700 selected">X</button>
                            <button data-mark="O" class="mark-btn config-btn flex-1 text-5xl py-2 px-4 rounded-lg shadow-md border-amber-800 btn-chunky bg-amber-600 text-blue-700">O</button>
                        </div>
                    </div>
                    <button id="start-computer-game-btn" class="w-full bg-green-700 text-white text-3xl py-4 px-8 rounded-lg shadow-md border-green-800 btn-chunky hover:bg-green-600 mb-3">Start Game</button>
                    <button class="back-to-main-menu-btn text-amber-700 hover:text-amber-900 text-xl w-full text-center">&larr; Go Back</button>
                </div>
            </section>
            
            <!-- Pass N Play Setup -->
            <section id="player-setup-screen" class="screen hidden">
                 <div class="bg-amber-100 p-8 rounded-2xl shadow-lg border-4 border-amber-900/20 text-center">
                    <h2 class="text-4xl font-bold text-amber-900 mb-6">Pass N Play Setup</h2>
                    <div class="space-y-4 mb-6">
                        <input type="text" id="player1-name-input" placeholder="Player 1 Name (X)" class="w-full text-2xl p-3 rounded-lg border-2 border-amber-300 focus:border-amber-600 focus:ring-0 text-center text-amber-900">
                        <input type="text" id="player2-name-input" placeholder="Player 2 Name (O)" class="w-full text-2xl p-3 rounded-lg border-2 border-amber-300 focus:border-amber-600 focus:ring-0 text-center text-amber-900">
                    </div>
                    <button id="start-player-game-btn" class="w-full bg-green-700 text-white text-3xl py-4 px-8 rounded-lg shadow-md border-green-800 btn-chunky hover:bg-green-600 mb-3">Start Game</button>
                    <button class="back-to-main-menu-btn text-amber-700 hover:text-amber-900 text-xl w-full text-center">&larr; Go Back</button>
                 </div>
            </section>

             <!-- Online Multiplayer Setup -->
            <section id="online-setup-screen" class="screen hidden">
                <div class="bg-amber-100 p-8 rounded-2xl shadow-lg border-4 border-amber-900/20 text-center">
                    <h2 class="text-4xl font-bold text-amber-900 mb-6">Play with Friend</h2>
                    <div id="online-options">
                        <div class="space-y-4">
                            <button id="create-game-btn" class="w-full bg-green-700 text-white text-3xl py-3 px-8 rounded-lg shadow-md border-green-800 btn-chunky hover:bg-green-600">Create Game</button>
                            <button id="join-game-prompt-btn" class="w-full bg-blue-700 text-white text-3xl py-3 px-8 rounded-lg shadow-md border-blue-800 btn-chunky hover:bg-blue-600">Join Game</button>
                        </div>
                    </div>
                    <div id="create-game-view" class="hidden">
                        <p class="text-xl text-amber-800 mb-2">Share this code with your friend:</p>
                        <div class="relative">
                            <div id="game-code-display" class="text-6xl font-mono tracking-widest bg-white p-4 rounded-lg shadow-inner text-amber-900 mb-4 select-all">------</div>
                             <button onclick="copyToClipboard('game-code-display')" class="absolute top-2 right-2 bg-gray-300 p-2 rounded-md hover:bg-gray-400 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                             </button>
                        </div>
                        <p id="connection-status" class="text-xl text-amber-700">Waiting for friend to join...</p>
                    </div>
                     <div id="join-game-view" class="hidden">
                        <p class="text-xl text-amber-800 mb-2">Enter the 6-digit game code:</p>
                        <input type="text" id="join-code-input" maxlength="6" class="w-full text-4xl font-mono tracking-widest p-3 rounded-lg border-2 border-amber-300 focus:border-amber-600 focus:ring-0 text-center text-amber-900 mb-4 uppercase">
                        <button id="join-game-btn" class="w-full bg-blue-700 text-white text-3xl py-3 px-8 rounded-lg shadow-md border-blue-800 btn-chunky hover:bg-blue-600">Join</button>
                        <p id="join-status" class="text-xl text-red-600 mt-2 h-6"></p>
                    </div>
                    <button class="back-to-main-menu-btn text-amber-700 hover:text-amber-900 text-xl w-full text-center mt-6">&larr; Go Back</button>
                </div>
            </section>
            
            <!-- Game Screen -->
            <section id="game-screen" class="screen hidden">
                <div class="bg-amber-100 p-6 sm:p-8 rounded-2xl shadow-lg border-4 border-amber-900/20 relative">
                    <div id="emoji-reaction" class=""></div>
                    <div class="flex justify-between items-center mb-6">
                        <div class="text-center bg-white/70 px-4 py-2 rounded-lg">
                            <p id="player-x-label" class="text-2xl text-red-700 font-bold truncate max-w-[100px]"></p>
                            <p id="player-x-score" class="text-4xl text-amber-900">0</p>
                        </div>
                        <p id="turn-indicator" class="text-2xl text-amber-800 bg-amber-200 px-4 py-2 rounded-lg shadow-inner"></p>
                         <div class="text-center bg-white/70 px-4 py-2 rounded-lg">
                            <p id="player-o-label" class="text-2xl text-blue-700 font-bold truncate max-w-[100px]"></p>
                            <p id="player-o-score" class="text-4xl text-amber-900">0</p>
                        </div>
                    </div>
                    <div id="game-board" class="grid grid-cols-3 gap-2 bg-amber-800 p-2 rounded-lg shadow-inner relative">
                        <div id="pause-overlay" class="hidden absolute inset-0 bg-black/70 rounded-lg flex-col items-center justify-center z-10">
                             <h2 class="text-5xl text-white mb-4">Paused</h2>
                             <button id="resume-btn" class="bg-amber-100 text-amber-900 text-2xl py-2 px-8 rounded-lg shadow-md border-amber-200 btn-chunky hover:bg-white">Resume</button>
                        </div>
                    </div>

                    <div class="mt-6 flex justify-between items-center">
                        <button id="main-menu-btn-game" class="bg-slate-400 text-slate-800 text-xl py-2 px-5 rounded-lg shadow-md border-slate-500 btn-chunky hover:bg-slate-300">Main Menu</button>
                        
                        <div id="chat-toggle-container" class="relative">
                            <button id="chat-toggle-btn" class="text-amber-900 text-2xl p-3 rounded-full shadow-md bg-amber-200 hover:bg-amber-300 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                            </button>
                            <div id="chat-notification-dot" class="hidden absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full border-2 border-amber-100"></div>
                        </div>

                        <button id="pause-btn" class="text-amber-900 text-2xl p-3 rounded-full shadow-md bg-amber-200 hover:bg-amber-300 transition">
                            <svg id="pause-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M6 4h4v16H6zM14 4h4v16h-4z"></path></svg>
                            <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="hidden"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                        </button>
                        <button id="reset-btn" class="bg-amber-900 text-amber-100 text-2xl py-3 px-6 rounded-lg shadow-md border-amber-950 btn-chunky hover:bg-amber-800">Reset</button>
                    </div>
                </div>
            </section>
        </div>
        
        <!-- Chat Modal -->
        <div id="chat-modal" class="hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[calc(100%-2rem)] max-w-lg z-30">
            <div class="bg-amber-100 p-4 rounded-2xl shadow-2xl border-4 border-amber-900/20">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-3xl text-amber-900">Chat</h3>
                    <button id="close-chat-btn" class="text-amber-600 hover:text-amber-900">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                <div id="chat-box" class="h-40 bg-white/70 rounded-lg p-2 overflow-y-auto mb-2 flex flex-col space-y-2 shadow-inner"></div>
                <div class="flex space-x-2">
                    <input type="text" id="chat-input" placeholder="Say hi..." class="flex-grow text-xl p-2 rounded-lg border-2 border-amber-300 focus:border-amber-600 focus:ring-0 text-amber-900">
                    <button id="send-chat-btn" class="bg-sky-700 text-white px-5 rounded-lg shadow-md border-sky-800 btn-chunky hover:bg-sky-600">Send</button>
                </div>
                <div class="flex justify-center space-x-2 mt-3">
                     <button class="emoji-btn text-3xl p-2 rounded-full bg-amber-200 hover:bg-amber-300 transition" data-emoji="👍">👍</button>
                     <button class="emoji-btn text-3xl p-2 rounded-full bg-amber-200 hover:bg-amber-300 transition" data-emoji="😂">😂</button>
                     <button class="emoji-btn text-3xl p-2 rounded-full bg-amber-200 hover:bg-amber-300 transition" data-emoji="🎉">🎉</button>
                     <button class="emoji-btn text-3xl p-2 rounded-full bg-amber-200 hover:bg-amber-300 transition" data-emoji="🤔">🤔</button>
                </div>
            </div>
        </div>

        <!-- Game Over Modal -->
        <div id="game-over-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-20">
             <div id="game-over-content" class="bg-amber-100 p-8 rounded-2xl shadow-2xl border-4 border-amber-900/20 text-center max-w-sm w-full">
                <h2 id="winner-message" class="text-5xl font-bold text-amber-900 mb-6">You Win!</h2>
                <div id="game-over-buttons" class="space-y-4">
                    <button id="play-again-btn" class="w-full bg-amber-800 text-amber-100 text-3xl py-3 px-8 rounded-lg shadow-md border-amber-950 btn-chunky hover:bg-amber-700">Play Again</button>
                    <button id="main-menu-btn-modal" class="w-full bg-slate-400 text-slate-800 text-2xl py-3 px-8 rounded-lg shadow-md border-slate-500 btn-chunky hover:bg-slate-300">Main Menu</button>
                </div>
                <div id="rematch-sent-view" class="hidden">
                    <p class="text-2xl text-amber-800">Rematch request sent...</p>
                </div>
             </div>
        </div>
        
        <!-- Rematch Request Modal -->
        <div id="rematch-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-40">
            <div class="bg-amber-100 p-8 rounded-2xl shadow-2xl border-4 border-amber-900/20 text-center max-w-sm w-full">
                <h2 id="rematch-message" class="text-4xl font-bold text-amber-900 mb-6">Opponent wants a rematch!</h2>
                <div class="flex space-x-4">
                    <button id="rematch-accept-btn" class="w-full bg-green-700 text-white text-2xl py-3 px-8 rounded-lg shadow-md border-green-800 btn-chunky hover:bg-green-600">Accept</button>
                    <button id="rematch-reject-btn" class="w-full bg-red-700 text-white text-2xl py-3 px-8 rounded-lg shadow-md border-red-800 btn-chunky hover:bg-red-600">Reject</button>
                </div>
            </div>
        </div>

    </div>
    
    <script>
        // --- Global Helper ---
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const textToCopy = element.innerText;
            navigator.clipboard.writeText(textToCopy).catch(err => {
                console.error('Failed to copy text: ', err);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const screens = {
                name: document.getElementById('name-screen'),
                mainMenu: document.getElementById('main-menu'),
                computerSetup: document.getElementById('computer-setup-screen'),
                playerSetup: document.getElementById('player-setup-screen'),
                onlineSetup: document.getElementById('online-setup-screen'),
                game: document.getElementById('game-screen'),
            };
            const chatModal = document.getElementById('chat-modal');
            const chatBox = document.getElementById('chat-box');
            const chatInput = document.getElementById('chat-input');
            const chatToggleContainer = document.getElementById('chat-toggle-container');
            const chatNotificationDot = document.getElementById('chat-notification-dot');
            const onlineOptions = document.getElementById('online-options');
            const createGameView = document.getElementById('create-game-view');
            const joinGameView = document.getElementById('join-game-view');
            const gameCodeDisplay = document.getElementById('game-code-display');
            const connectionStatus = document.getElementById('connection-status');
            const joinCodeInput = document.getElementById('join-code-input');
            const joinStatus = document.getElementById('join-status');
            const emojiReaction = document.getElementById('emoji-reaction');
            const gameOverModal = document.getElementById('game-over-modal');
            const gameOverButtons = document.getElementById('game-over-buttons');
            const rematchSentView = document.getElementById('rematch-sent-view');
            const rematchModal = document.getElementById('rematch-modal');

            // --- Buttons ---
            document.getElementById('save-name-btn').addEventListener('click', saveNameAndGoToMenu);
            document.getElementById('edit-name-btn').addEventListener('click', () => showScreen('name'));
            document.getElementById('vs-computer-btn').addEventListener('click', () => showScreen('computerSetup'));
            document.getElementById('vs-player-btn').addEventListener('click', () => showScreen('playerSetup'));
            document.getElementById('online-btn').addEventListener('click', () => showScreen('onlineSetup'));
            document.getElementById('start-computer-game-btn').addEventListener('click', startComputerGame);
            document.getElementById('start-player-game-btn').addEventListener('click', startPlayerGame);
            document.getElementById('reset-btn').addEventListener('click', () => resetGame());
            document.getElementById('pause-btn').addEventListener('click', togglePause);
            document.getElementById('resume-btn').addEventListener('click', togglePause);
            document.getElementById('play-again-btn').addEventListener('click', handlePlayAgain);
            document.getElementById('main-menu-btn-modal').addEventListener('click', handleGameOverMainMenu);
            document.querySelectorAll('.config-btn').forEach(b => b.addEventListener('click', handleConfigSelection));
            document.querySelectorAll('.back-to-main-menu-btn').forEach(b => b.addEventListener('click', returnToMainMenu));
            document.getElementById('create-game-btn').addEventListener('click', createGame);
            document.getElementById('join-game-prompt-btn').addEventListener('click', () => {
                onlineOptions.classList.add('hidden');
                joinGameView.classList.remove('hidden');
            });
            document.getElementById('join-game-btn').addEventListener('click', joinGame);
            document.getElementById('chat-toggle-btn').addEventListener('click', toggleChat);
            document.getElementById('close-chat-btn').addEventListener('click', toggleChat);
            document.getElementById('send-chat-btn').addEventListener('click', sendChatMessage);
            chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendChatMessage(); });
            document.querySelectorAll('.emoji-btn').forEach(btn => btn.addEventListener('click', sendEmojiReaction));
            document.getElementById('rematch-accept-btn').addEventListener('click', handleRematchAccept);
            document.getElementById('rematch-reject-btn').addEventListener('click', handleRematchReject);

            // --- Game State & WebRTC State ---
            let gameState = Array(9).fill('');
            let currentPlayer, gameActive, isPaused, gameMode;
            let playerNames = { X: 'Player 1', O: 'Player 2' };
            let difficulty, humanPlayer, computerPlayer;
            let scores = { X: 0, O: 0 };
            let lastMoveIndex = -1;
            const winningConditions = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            
            let peer;
            let conn;
            let localPlayerMark;

            function generatePeerId() {
                return Math.random().toString(36).substring(2, 8).toUpperCase();
            }

            function createGame() {
                onlineOptions.classList.add('hidden');
                createGameView.classList.remove('hidden');
                const peerId = generatePeerId();
                peer = new Peer(peerId);
                
                peer.on('open', (id) => {
                    gameCodeDisplay.textContent = id;
                    localPlayerMark = 'X';
                });

                peer.on('connection', (connection) => {
                    conn = connection;
                    setupConnectionEvents();
                });

                peer.on('error', (err) => {
                    console.error("PeerJS Error:", err);
                    connectionStatus.textContent = "Error. Please refresh.";
                });
            }

            function joinGame() {
                const roomCode = joinCodeInput.value.toUpperCase();
                if (roomCode.length !== 6) {
                    joinStatus.textContent = "Code must be 6 characters.";
                    return;
                }
                joinStatus.textContent = "Connecting...";
                
                peer = new Peer();

                peer.on('open', () => {
                    conn = peer.connect(roomCode);
                    setupConnectionEvents();
                });

                peer.on('error', (err) => {
                    console.error("PeerJS Error:", err);
                    joinStatus.textContent = "Failed to connect. Check code.";
                });

                localPlayerMark = 'O';
            }

            function setupConnectionEvents() {
                conn.on('open', () => {
                    // Exchange names on connect
                    const myName = localStorage.getItem('ticTacToePlayerName') || 'Player';
                    sendData({ type: 'name', name: myName });
                    startOnlineGame();
                });

                conn.on('data', (data) => {
                    switch (data.type) {
                        case 'name':
                            const opponentMark = localPlayerMark === 'X' ? 'O' : 'X';
                            playerNames[opponentMark] = data.name;
                            updateScoreboardUI();
                            break;
                        case 'move':
                            makeMove(data.index, data.player);
                            handlePlayerChange();
                            break;
                        case 'chat':
                            displayChatMessage(data.message, false);
                            break;
                        case 'emoji':
                            showEmojiReaction(data.emoji);
                            break;
                        case 'rematch-request':
                            rematchModal.classList.remove('hidden');
                            break;
                        case 'rematch-accept':
                            rematchModal.classList.add('hidden');
                            gameOverModal.classList.add('hidden');
                            resetGame(false);
                            break;
                        case 'rematch-reject':
                            alert("Opponent rejected the rematch.");
                            returnToMainMenu();
                            break;
                        case 'go-to-menu':
                             returnToMainMenu();
                             break;
                        case 'reset':
                            resetGame(false);
                            break;
                    }
                });
                 conn.on('close', () => {
                    alert("Friend has disconnected.");
                    returnToMainMenu();
                 });
            }

            function sendData(data) {
                if (conn && conn.open) {
                    conn.send(data);
                }
            }
            
            function startOnlineGame() {
                gameMode = 'online';
                const storedName = localStorage.getItem('ticTacToePlayerName') || 'You';
                playerNames[localPlayerMark] = storedName;
                startGame();
            }

            // Chat UI Logic
            function toggleChat() {
                chatModal.classList.toggle('hidden');
                if (!chatModal.classList.contains('hidden')) {
                    chatNotificationDot.classList.add('hidden');
                }
            }

            function sendChatMessage() {
                const message = chatInput.value.trim();
                if (message) {
                    sendData({ type: 'chat', message });
                    displayChatMessage(message, true);
                    chatInput.value = '';
                }
            }
            
            function displayChatMessage(message, isMine) {
                if(chatModal.classList.contains('hidden') && !isMine) {
                    chatNotificationDot.classList.remove('hidden');
                }
                const alignClass = isMine ? 'self-end' : 'self-start';
                const colorClass = isMine ? 'bg-blue-200' : 'bg-gray-200';
                const msgDiv = document.createElement('div');
                msgDiv.className = `chat-message p-2 rounded-lg ${alignClass} ${colorClass}`;
                msgDiv.textContent = message;
                chatBox.appendChild(msgDiv);
                chatBox.scrollTop = chatBox.scrollHeight;
            }

            function sendEmojiReaction(e) {
                const emoji = e.currentTarget.dataset.emoji;
                sendData({ type: 'emoji', emoji });
            }

            function showEmojiReaction(emoji) {
                emojiReaction.textContent = emoji;
                emojiReaction.classList.add('show');
                setTimeout(() => emojiReaction.classList.remove('show'), 1500);
            }

            function handleCellClick(event) {
                const index = parseInt(event.currentTarget.dataset.index);
                if (gameState[index] !== '' || !gameActive || isPaused) return;

                if (gameMode === 'online') {
                    if (currentPlayer !== localPlayerMark) return; // Not my turn
                    sendData({ type: 'move', index, player: currentPlayer });
                } else if (gameMode === 'vsComputer' && currentPlayer !== humanPlayer) {
                    return;
                }

                makeMove(index, currentPlayer);

                if (gameActive) {
                    handlePlayerChange();
                    if (gameMode === 'vsComputer' && currentPlayer === computerPlayer) {
                        setTimeout(computerMove, 500);
                    }
                }
            }
            
            function handlePlayAgain() {
                if (gameMode === 'online') {
                    sendData({type: 'rematch-request'});
                    gameOverButtons.classList.add('hidden');
                    rematchSentView.classList.remove('hidden');
                } else {
                    resetGame();
                }
            }

            function handleGameOverMainMenu() {
                if (gameMode === 'online') {
                    sendData({type: 'go-to-menu'});
                }
                returnToMainMenu();
            }

            function handleRematchAccept() {
                sendData({type: 'rematch-accept'});
                rematchModal.classList.add('hidden');
                gameOverModal.classList.add('hidden');
                resetGame(false);
            }

            function handleRematchReject() {
                sendData({type: 'rematch-reject'});
                returnToMainMenu();
            }

            // --- Core Game Logic & UI (mostly unchanged) ---
            const gameBoard = document.getElementById('game-board');
            const turnIndicator = document.getElementById('turn-indicator');
            const winnerMessage = document.getElementById('winner-message');
            const scoresUI = {
                xLabel: document.getElementById('player-x-label'),
                xScore: document.getElementById('player-x-score'),
                oLabel: document.getElementById('player-o-label'),
                oScore: document.getElementById('player-o-score'),
            };
            const pauseIcon = document.getElementById('pause-icon');
            const playIcon = document.getElementById('play-icon');

            function init() {
                createBoard();
                const storedName = localStorage.getItem('ticTacToePlayerName');
                if (storedName) {
                    document.getElementById('welcome-message').textContent = `Welcome, ${storedName}!`;
                    showScreen('mainMenu');
                } else {
                    showScreen('name');
                }
            }

            function showScreen(screenName) {
                Object.values(screens).forEach(screen => screen.classList.add('hidden'));
                screens[screenName].classList.remove('hidden');
            }
            
            function saveNameAndGoToMenu() {
                const name = document.getElementById('player-name-input').value.trim();
                if (name) {
                    localStorage.setItem('ticTacToePlayerName', name);
                    document.getElementById('welcome-message').textContent = `Welcome, ${name}!`;
                    showScreen('mainMenu');
                }
            }

            function handleConfigSelection(e) {
                const group = e.target.closest('div').querySelectorAll('.config-btn');
                group.forEach(b => b.classList.remove('selected'));
                e.target.classList.add('selected');
            }
            
            function startComputerGame() {
                gameMode = 'vsComputer';
                difficulty = document.querySelector('.difficulty-btn.selected').dataset.difficulty;
                humanPlayer = document.querySelector('.mark-btn.selected').dataset.mark;
                computerPlayer = humanPlayer === 'X' ? 'O' : 'X';
                
                const storedName = localStorage.getItem('ticTacToePlayerName') || 'Player';
                playerNames[humanPlayer] = storedName;
                playerNames[computerPlayer] = 'Computer';
                
                startGame();
            }

            function startPlayerGame() {
                gameMode = 'vsPlayer';
                playerNames.X = document.getElementById('player1-name-input').value.trim() || 'Player 1';
                playerNames.O = document.getElementById('player2-name-input').value.trim() || 'Player 2';
                startGame();
            }

            function startGame() {
                scores = { X: 0, O: 0 };
                updateScoreboardUI();
                
                document.getElementById('reset-btn').style.display = gameMode === 'online' ? 'none' : 'block';
                document.getElementById('pause-btn').style.display = gameMode === 'online' ? 'none' : 'block';
                document.getElementById('main-menu-btn-game').style.display = gameMode === 'online' ? 'none' : 'block';
                chatToggleContainer.style.display = gameMode === 'online' ? 'block' : 'none';

                showScreen('game');
                resetGame(false); // don't send signal on initial start
            }

            function returnToMainMenu() {
                if (peer) { peer.destroy(); }
                if (conn) { conn.close(); }
                peer = null;
                conn = null;
                
                // Reset UI elements
                chatModal.classList.add('hidden');
                chatBox.innerHTML = '';
                onlineOptions.classList.remove('hidden');
                createGameView.classList.add('hidden');
                joinGameView.classList.add('hidden');
                joinCodeInput.value = '';
                joinStatus.textContent = '';
                gameCodeDisplay.textContent = '------';
                rematchModal.classList.add('hidden');
                gameOverModal.classList.add('hidden');

                showScreen('mainMenu');
            }

            function resetGame(sendSignal = true) {
                if (gameMode === 'online' && sendSignal) {
                     sendData({ type: 'reset' });
                }
                gameState.fill('');
                currentPlayer = 'X';
                gameActive = true;
                isPaused = false;
                
                gameOverModal.classList.add('hidden');
                rematchModal.classList.add('hidden');
                gameOverButtons.classList.remove('hidden');
                rematchSentView.classList.add('hidden');
                
                document.getElementById('pause-overlay').classList.add('hidden');

                updateBoard();
                highlightLastMove(-1);
                updateTurnIndicator();
                togglePauseIcon(false);

                if (gameMode === 'vsComputer' && currentPlayer === computerPlayer) {
                    setTimeout(computerMove, 500);
                }
            }

            function makeMove(index, player) {
                if (gameState[index] === '' && gameActive) {
                    gameState[index] = player;
                    updateBoard();
                    highlightLastMove(index);
                    checkResult();
                }
            }

            function checkResult() {
                const result = checkWinner();
                if (result) {
                    gameActive = false;
                    winnerMessage.textContent = (result === 'T') ? "It's a Draw!" : `${playerNames[result]} Wins!`;
                    if (result !== 'T') {
                        scores[result]++;
                        updateScoreboardUI();
                    }
                    setTimeout(() => gameOverModal.classList.remove('hidden'), 500);
                }
            }
            
            // --- UI Updates ---
            function createBoard() {
                // Remove only old game cells, preserving the pause overlay
                gameBoard.querySelectorAll('[data-index]').forEach(cell => cell.remove());
                
                // Create and append new cells
                for (let i = 0; i < 9; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'flex items-center justify-center bg-amber-600 rounded-md aspect-square cursor-pointer hover:bg-amber-500 transition-colors';
                    cell.dataset.index = i;
                    const span = document.createElement('span');
                    span.className = 'text-7xl'; cell.appendChild(span);
                    cell.addEventListener('click', handleCellClick);
                    gameBoard.appendChild(cell);
                }
            }
            
            function updateBoard() {
                gameBoard.querySelectorAll('[data-index]').forEach((cell, i) => {
                    const span = cell.querySelector('span');
                    span.textContent = gameState[i];
                    span.classList.toggle('text-red-700', gameState[i] === 'X');
                    span.classList.toggle('text-blue-700', gameState[i] === 'O');
                });
            }

            function updateScoreboardUI() {
                scoresUI.xLabel.textContent = `${playerNames.X} (X)`;
                scoresUI.oLabel.textContent = `${playerNames.O} (O)`;
                scoresUI.xScore.textContent = scores.X;
                scoresUI.oScore.textContent = scores.O;
            }
            
            function updateTurnIndicator() {
                const colorClass = currentPlayer === 'X' ? 'text-red-700' : 'text-blue-700';
                turnIndicator.innerHTML = `<span class="${colorClass} font-bold">${playerNames[currentPlayer]}'s</span> Turn`;
            }

            function togglePause() {
                if (!gameActive || gameMode === 'online') return;
                isPaused = !isPaused;
                document.getElementById('pause-overlay').classList.toggle('hidden'); 
                document.getElementById('pause-overlay').classList.toggle('flex');
                togglePauseIcon(isPaused);
            }

            function togglePauseIcon(paused) {
                pauseIcon.classList.toggle('hidden', paused); playIcon.classList.toggle('hidden', !paused);
            }

            function highlightLastMove(index) {
                if (lastMoveIndex !== -1) gameBoard.querySelector(`[data-index='${lastMoveIndex}']`)?.classList.remove('cell-highlight');
                if (index !== -1) gameBoard.querySelector(`[data-index='${index}']`)?.classList.add('cell-highlight');
                lastMoveIndex = index;
            }

            // --- Helper & AI Functions ---
            const handlePlayerChange = () => { currentPlayer = (currentPlayer === 'X') ? 'O' : 'X'; updateTurnIndicator(); };
            const checkWinner = (b = gameState) => { for(const c of winningConditions) if(b[c[0]]&&b[c[0]]===b[c[1]]&&b[c[0]]===b[c[2]]) return b[c[0]]; return b.includes('')?null:'T'; };
            const getRandomMove = () => { const e=gameState.map((v,i)=>v===''?i:null).filter(v=>v!==null); return e.length?e[Math.floor(Math.random()*e.length)]:-1; };
            
            function computerMove() {
                if (!gameActive || isPaused) return;
                let moveIndex = (difficulty === 'easy') ? getRandomMove() : (difficulty === 'medium' && Math.random() < 0.4) ? getRandomMove() : findBestMove();
                if (moveIndex !== -1) {
                    makeMove(moveIndex, computerPlayer);
                    if (gameActive) handlePlayerChange();
                }
            }

            function findBestMove() {
                let bestScore = -Infinity; let move = -1;
                for (let i=0; i<9; i++) {
                    if (gameState[i] === '') {
                        gameState[i] = computerPlayer;
                        let score = minimax(gameState, 0, false);
                        gameState[i] = '';
                        if (score > bestScore) { bestScore = score; move = i; }
                    }
                }
                return move === -1 ? getRandomMove() : move;
            }

            function minimax(board, depth, isMaximizing) {
                const result = checkWinner(board);
                if (result !== null) return result === computerPlayer ? 10 - depth : (result === humanPlayer ? depth - 10 : 0);
                let bestScore = isMaximizing ? -Infinity : Infinity;
                for (let i = 0; i < 9; i++) {
                    if (board[i] === '') {
                        board[i] = isMaximizing ? computerPlayer : humanPlayer;
                        let score = minimax(board, depth + 1, !isMaximizing);
                        board[i] = '';
                        bestScore = isMaximizing ? Math.max(score, bestScore) : Math.min(score, bestScore);
                    }
                }
                return bestScore;
            }

            init(); // Start the app
        });
    </script>
</body>
</html>

